[
  {
    "path": "posts/2021-10-16-svg/",
    "title": "Interactive SVG with D3.js",
    "description": "Part 1: add interactivity to existing WA sheets.",
    "author": [
      {
        "name": "BACOU, Melanie",
        "url": "https://linkedin/in/mbacou"
      }
    ],
    "date": "2021-10-18",
    "categories": [],
    "contents": "\n\nContents\nData Preparation\nInteractive SVG\nGraphviz\n\nThis notebook is to explore multiple visualization schemes:\nInteractive SVG: add user interactivity to existing SVG (or simplified) designs using low-level D3.js library\nGraphviz: redesign the WA+ sheets using Graphviz and provide interactivity with DiagrammeR\nHighcharts: reshape WA+ model output to create standard treemaps using Highcharts.js charting library\nHighcharts: reshape WA+ model output to create steam graphs and/or network graphs\nLeaflet: create a 3D map of basin landscape with SVG annotations (arrows, etc.) using leaflet.js\nThe D3.js approach is the more flexible scheme but also the more difficult to implement. Other approaches will be developed in separate notebooks.\nData Preparation\nTo validate the different approaches we use sample model output and datasets provided by Naga Valpuri for Mali (Niger river basin) and Kenya (Mara basin).\n\n\nShow code\n\ndata <- list(\n  ken = \"../../_data/ken/hydroloop_results/csv\",\n  mli = \"../../_data/mli/csv_km3\"\n) %>%\n  lapply(list.files, pattern=\"*.csv\", recursive=TRUE, full.names=TRUE) %>%\n  lapply(data.table) %>%\n  rbindlist(idcol=\"iso3\", use.names=TRUE, fill=TRUE) %>%\n  setnames(\"V1\", \"path\")\n\ndata[, \n  file := basename(path)\n][, `:=`(\n  year = str_extract(file, \"_[0-9]{4}\") %>% str_sub(2,5) %>% as.integer(),\n  month = str_extract(file, \"[0-9]{4}_[0-9]{1,2}\") %>% str_sub(6,7) %>% as.integer()\n)] %>% setorder(iso3, year, month, na.last=TRUE)\n\ndata[iso3==\"ken\", .(file, year, month)][c(1:5, (.N-4):.N)] %>% \n  kable(caption=\"Kenya - List of output files (top and last 5)\")\n\n\nTable 1: Kenya - List of output files (top and last 5)\nfile\nyear\nmonth\nsheet1_2003_1.csv\n2003\n1\nsheet2_2003_1.csv\n2003\n1\nsheet1_2003_2.csv\n2003\n2\nsheet2_2003_2.csv\n2003\n2\nsheet1_2003_3.csv\n2003\n3\nsheet5_subbasin_1_supply_sw.csv\n–\n–\nsheet6_recharge.csv\n–\n–\nsheet6_return_gw_from_gw.csv\n–\n–\nsheet6_return_gw_from_sw.csv\n–\n–\nsheet6_supply_gw.csv\n–\n–\n\nShow code\n\ndata[iso3==\"mli\", .(file, year, month)] %>% \n  kable(caption=\"Mali - List of output files\")\n\n\nTable 1: Mali - List of output files\nfile\nyear\nmonth\nSheet1_2010.csv\n2010\n–\nSheet1_2011.csv\n2011\n–\nSheet1_2012.csv\n2012\n–\nSheet1_2013.csv\n2013\n–\nSheet1_2014.csv\n2014\n–\nSheet1_2015.csv\n2015\n–\nSheet1_2016.csv\n2016\n–\nSheet1_2017.csv\n2017\n–\n\nIn particular we have yearly (2 seasons) model steps for Mali and monthly steps for Kenya that are further aggregated to seasonal and yearly time spans (by variable), as well as monthly time-series. In Mali only Sheet 1 was produced (Resource Base).\nLet’s load a sample output for Kenya for the year 2017.\n\n\nShow code\n\nf <- \"sheet1_2017.csv\"\nken <- data[iso3==\"ken\" & file==f][1, fread(path)]\nken %>% \n  kable(caption=f)\n\n\nTable 2: sheet1_2017.csv\nCLASS\nSUBCLASS\nVARIABLE\nVALUE\nINFLOW\nPRECIPITATION\nRainfall\n13.1648139\nINFLOW\nPRECIPITATION\nSnowfall\n0.0000000\nINFLOW\nPRECIPITATION\nPrecipitation recycling\n0.0000000\nINFLOW\nSURFACE WATER\nMain riverstem\n0.0000000\nINFLOW\nSURFACE WATER\nTributaries\n0.0000000\nINFLOW\nSURFACE WATER\nUtilized surface water\n0.0000000\nINFLOW\nSURFACE WATER\nFlood\n0.0000000\nINFLOW\nGROUNDWATER\nNatural\n0.0000000\nINFLOW\nGROUNDWATER\nUtilized\n0.0000000\nINFLOW\nOTHER\nDesalinized\n0.0000000\nSTORAGE\nCHANGE\nSurface storage\n-3.8472840\nSTORAGE\nCHANGE\nStorage in sinks\n0.0000000\nOUTFLOW\nET LANDSCAPE\nProtected\n1.3877507\nOUTFLOW\nET LANDSCAPE\nUtilized\n2.4564371\nOUTFLOW\nET LANDSCAPE\nModified\n3.0237088\nOUTFLOW\nET LANDSCAPE\nManaged\n0.0985108\nOUTFLOW\nET UTILIZED FLOW\nProtected\n0.0124669\nOUTFLOW\nET UTILIZED FLOW\nUtilized\n0.6943683\nOUTFLOW\nET UTILIZED FLOW\nModified\n0.0771237\nOUTFLOW\nET UTILIZED FLOW\nManaged\n0.6134008\nOUTFLOW\nET INCREMENTAL\nManmade\n0.0023120\nOUTFLOW\nET INCREMENTAL\nNatural\n0.7839588\nOUTFLOW\nSURFACE WATER\nMain riverstem\n1.5648516\nOUTFLOW\nSURFACE WATER\nTributaries\n0.0000000\nOUTFLOW\nSURFACE WATER\nUtilized surface water\n0.0000000\nOUTFLOW\nSURFACE WATER\nFlood\n0.0000000\nOUTFLOW\nSURFACE WATER\nInterbasin transfer\n0.0000000\nOUTFLOW\nGROUNDWATER\nNatural\n0.0000000\nOUTFLOW\nGROUNDWATER\nUtilized\n0.0000000\nOUTFLOW\nOTHER\nNon-utilizable\n0.0000000\nOUTFLOW\nOTHER\nOther\n0.0000000\nOUTFLOW\nRESERVED\nCommited\n0.6405242\nOUTFLOW\nRESERVED\nNavigational\n0.0000000\nOUTFLOW\nRESERVED\nEnvironmental\n0.0000000\n\nThis file lists 34 output variables grouped into CLASS and SUBCLASS. Units are in km³/year.\nAnd monthly time-series of Incremental ET by land-use classes:\n\n\nShow code\n\nf <- \"sheet1_basin_etincr_monthly.csv\"\nken.ts <- data[iso3==\"ken\" & file==f][1, fread(path)]\nken.ts[c(1:5, (.N-4):.N)] %>% \n  kable(caption=f)\n\n\nTable 3: sheet1_basin_etincr_monthly.csv\ntime\nPROTECTED\nUTILIZED\nMODIFIED\nMANAGED\n2003-01-01\n105298.00723\n204086.40\n181514.997\n7261.8200309\n2003-02-01\n37643.26220\n140818.12\n78636.788\n1735.2680508\n2003-03-01\n28.18953\n62013.62\n519.323\n0.5871521\n2003-04-01\n36.06855\n52657.25\n0.000\n0.0000000\n2003-05-01\n25517.84019\n103041.12\n9941.965\n231.0952713\n2017-08-01\n46.66657\n53048.12\n10351.687\n61.5757237\n2017-09-01\n2887.49425\n63199.20\n7579.530\n234.1257521\n2017-10-01\n930.76087\n57975.49\n1419.639\n180.7505872\n2017-11-01\n572.72727\n50319.87\n764.227\n29.8497814\n2017-12-01\n857.45494\n75332.54\n8161.350\n221.3077603\n\nWe make the yearly dataset available in the client as a JSON array named data. We also pass a default color palette pal.\n\n\nShow code\n\ncat(sprintf(\"\n  <script> \n  var data = %s;\n  var pal = %s;\n  <\/script>\", toJSON(ken), toJSON(pal)))\n\n\n \n  var data = [{\"CLASS\":\"INFLOW\",\"SUBCLASS\":\"PRECIPITATION\",\"VARIABLE\":\"Rainfall\",\"VALUE\":13.1648},{\"CLASS\":\"INFLOW\",\"SUBCLASS\":\"PRECIPITATION\",\"VARIABLE\":\"Snowfall\",\"VALUE\":0},{\"CLASS\":\"INFLOW\",\"SUBCLASS\":\"PRECIPITATION\",\"VARIABLE\":\"Precipitation recycling\",\"VALUE\":0},{\"CLASS\":\"INFLOW\",\"SUBCLASS\":\"SURFACE WATER\",\"VARIABLE\":\"Main riverstem\",\"VALUE\":0},{\"CLASS\":\"INFLOW\",\"SUBCLASS\":\"SURFACE WATER\",\"VARIABLE\":\"Tributaries\",\"VALUE\":0},{\"CLASS\":\"INFLOW\",\"SUBCLASS\":\"SURFACE WATER\",\"VARIABLE\":\"Utilized surface water\",\"VALUE\":0},{\"CLASS\":\"INFLOW\",\"SUBCLASS\":\"SURFACE WATER\",\"VARIABLE\":\"Flood\",\"VALUE\":0},{\"CLASS\":\"INFLOW\",\"SUBCLASS\":\"GROUNDWATER\",\"VARIABLE\":\"Natural\",\"VALUE\":0},{\"CLASS\":\"INFLOW\",\"SUBCLASS\":\"GROUNDWATER\",\"VARIABLE\":\"Utilized\",\"VALUE\":0},{\"CLASS\":\"INFLOW\",\"SUBCLASS\":\"OTHER\",\"VARIABLE\":\"Desalinized\",\"VALUE\":0},{\"CLASS\":\"STORAGE\",\"SUBCLASS\":\"CHANGE\",\"VARIABLE\":\"Surface storage\",\"VALUE\":-3.8473},{\"CLASS\":\"STORAGE\",\"SUBCLASS\":\"CHANGE\",\"VARIABLE\":\"Storage in sinks\",\"VALUE\":0},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"ET LANDSCAPE\",\"VARIABLE\":\"Protected\",\"VALUE\":1.3878},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"ET LANDSCAPE\",\"VARIABLE\":\"Utilized\",\"VALUE\":2.4564},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"ET LANDSCAPE\",\"VARIABLE\":\"Modified\",\"VALUE\":3.0237},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"ET LANDSCAPE\",\"VARIABLE\":\"Managed\",\"VALUE\":0.0985},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"ET UTILIZED FLOW\",\"VARIABLE\":\"Protected\",\"VALUE\":0.0125},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"ET UTILIZED FLOW\",\"VARIABLE\":\"Utilized\",\"VALUE\":0.6944},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"ET UTILIZED FLOW\",\"VARIABLE\":\"Modified\",\"VALUE\":0.0771},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"ET UTILIZED FLOW\",\"VARIABLE\":\"Managed\",\"VALUE\":0.6134},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"ET INCREMENTAL\",\"VARIABLE\":\"Manmade\",\"VALUE\":0.0023},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"ET INCREMENTAL\",\"VARIABLE\":\"Natural\",\"VALUE\":0.784},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"SURFACE WATER\",\"VARIABLE\":\"Main riverstem\",\"VALUE\":1.5649},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"SURFACE WATER\",\"VARIABLE\":\"Tributaries\",\"VALUE\":0},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"SURFACE WATER\",\"VARIABLE\":\"Utilized surface water\",\"VALUE\":0},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"SURFACE WATER\",\"VARIABLE\":\"Flood\",\"VALUE\":0},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"SURFACE WATER\",\"VARIABLE\":\"Interbasin transfer\",\"VALUE\":0},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"GROUNDWATER\",\"VARIABLE\":\"Natural\",\"VALUE\":0},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"GROUNDWATER\",\"VARIABLE\":\"Utilized\",\"VALUE\":0},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"OTHER\",\"VARIABLE\":\"Non-utilizable\",\"VALUE\":0},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"OTHER\",\"VARIABLE\":\"Other\",\"VALUE\":0},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"RESERVED\",\"VARIABLE\":\"Commited\",\"VALUE\":0.6405},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"RESERVED\",\"VARIABLE\":\"Navigational\",\"VALUE\":0},{\"CLASS\":\"OUTFLOW\",\"SUBCLASS\":\"RESERVED\",\"VARIABLE\":\"Environmental\",\"VALUE\":0}];\n  var pal = [\"#253655CC\",\"#37517ECC\",\"#2ED06ECC\",\"#008EC0CC\",\"#FFA600CC\",\"#C22E2ECC\"];\n  \nInteractive SVG\nIn this section we work off the existing SVG designs, using D3.js library to add data binding and interactions. An important drawback of this approach is that each SVG element (rectangle, arrow, text, etc.) is tied to a data variable, so any change in the underlying data schema (esp. renaming of output variables) would require to manually edit the corresponding SVG sheet (using a text or vector graphic editor).\nThere are multiple SVG template sheets provided in the Kenya code repository (under ./scripts/WAsheets/template/svg). They are shown below.\n\n\nShow code\n\nsvg <- \"../../www/svg\" %>%\n  list.files(pattern=\"*.svg\", full.names=TRUE)\n\ninclude_graphics(svg[-c(1:2, 6)])\n\n\n\n\nWe focus first on the Resource Base sheet. Note that these sheets were created in Inkscape using SVG 1.1 specifications. They are complex designs and not optimized for rendering in a browser, so we start by testing a few simple interactions.\nBelow we load the Resource Base sheet using D3.js and proceed to map each box height/width and label to an output variable. We also create a dummy SVG barchart widget to make sure that data is read and rendered in the browser as expected.\nNote that d3.js needs to be provided as an external dependency to this notebook.\nDummy SVG widget using sample Kenya data.\n\n\n\n\n\nShow code\n\n// Keep only positive variables\nvar dd = data.filter((d) => (d.VALUE > 0));\n\nlet hw = 500;\nlet box = 20;\n\nvar svg = d3v6.select(\"#d3ex1\")\n  .append(\"svg\")\n  .attr(\"width\", hw)\n  .attr(\"height\", 340); \n\nsvg  \n  .selectAll(\"rect\")\n  .data(dd)\n  .enter()\n  .append(\"rect\")\n  .attr(\"x\", 5)\n  .attr(\"y\", (_, i) => (i * (box+5)+5) )\n  .attr(\"width\", (d) => (d.VALUE * 500/14) )\n  .attr(\"height\", box)\n  .attr(\"fill\", pal[1])\n  .on(\"mouseover\", handleMouseOver)\n  .on(\"mouseout\", handleMouseOut);\n\nsvg\n  .selectAll(\"text\")\n  .data(dd)\n  .enter()\n  .append(\"text\")\n  .attr(\"x\", 5)\n  .attr(\"y\", (_, i) => (i * (box+5)+15) )\n  .attr(\"fill\", \"black\")\n  .text((d) => (d.VARIABLE));\n\n// Test interactions\nfunction handleMouseOver(d, i) {\nd3v6.select(this)\n.attr(\"fill\", pal[3])\n};\n\nfunction handleMouseOut(d, i) {\nd3v6.select(this)\n.attr(\"fill\", pal[1])\n};\n\n// Test transformations\nvar tt = svg.selectAll(\"text\");\nsetTimeout(() => {\ntt.move(0, 10)\n}, 2000);\n\nd3v6.selection.prototype.move = function(x, y) {\nthis.attr(\"transform\", \"translate(\" + x + \",\" + y + \")\");\nreturn this;\n};\n\n\n// Keep only positive variables\nvar dd = data.filter((d) => (d.VALUE > 0));\n\nlet hw = 500;\nlet box = 20;\n\nvar svg = d3v6.select(\"#d3ex1\")\n  .append(\"svg\")\n  .attr(\"width\", hw)\n  .attr(\"height\", 340); \n\nsvg  \n  .selectAll(\"rect\")\n  .data(dd)\n  .enter()\n  .append(\"rect\")\n  .attr(\"x\", 5)\n  .attr(\"y\", (_, i) => (i * (box+5)+5) )\n  .attr(\"width\", (d) => (d.VALUE * 500/14) )\n  .attr(\"height\", box)\n  .attr(\"fill\", pal[1])\n  .on(\"mouseover\", handleMouseOver)\n  .on(\"mouseout\", handleMouseOut);\n\nsvg\n  .selectAll(\"text\")\n  .data(dd)\n  .enter()\n  .append(\"text\")\n  .attr(\"x\", 5)\n  .attr(\"y\", (_, i) => (i * (box+5)+15) )\n  .attr(\"fill\", \"black\")\n  .text((d) => (d.VARIABLE));\n\n// Test interactions\nfunction handleMouseOver(d, i) {\nd3v6.select(this)\n.attr(\"fill\", pal[3])\n};\n\nfunction handleMouseOut(d, i) {\nd3v6.select(this)\n.attr(\"fill\", pal[1])\n};\n\n// Test transformations\nvar tt = svg.selectAll(\"text\");\nsetTimeout(() => {\ntt.move(0, 10)\n}, 2000);\n\nd3v6.selection.prototype.move = function(x, y) {\nthis.attr(\"transform\", \"translate(\" + x + \",\" + y + \")\");\nreturn this;\n};\n\n\n\nOriginal SVG design with data bindings.\n\n\n\n\n\nShow code\n\nvar div = d3v6.select(\"#d3ex2\");\n\n// Append external design\nd3v6.xml(\"../../www/svg/sheet_1.svg\")\n  .then(d => {\n  div.node().append(d.documentElement);\n  });\n\nvar svg = div.select(\"svg\");\n\nsvg\n  .selectAll(\"text\")\n  .data(data)\n  .enter()\n  .text((d) => (d.VALUE) );\n\n\nvar div = d3v6.select(\"#d3ex2\");\n\n// Append external design\nd3v6.xml(\"../../www/svg/sheet_1.svg\")\n  .then(d => {\n  div.node().append(d.documentElement);\n  });\n\nvar svg = div.select(\"svg\");\n\nsvg\n  .selectAll(\"text\")\n  .data(data)\n  .enter()\n  .text((d) => (d.VALUE) );\n\n\nNow that we have the SVG DOM loaded, we can enumerate its elements, in particular we can list all data-driven elements with default value “NaN”.\n\n\nShow code\n\nsetTimeout(() => {\nsvg.move(0, 10)\n}, 2000);\n\nGraphviz\n\n\n\n",
    "preview": "posts/2021-10-16-svg/../../www/svg/sheet_1.svg",
    "last_modified": "2021-10-18T07:14:14+01:00",
    "input_file": {}
  },
  {
    "path": "posts/2021-18-highcharts/",
    "title": "Custom Highcharts",
    "description": "Part 2: build custom data-driven charts using Highcharts.js.",
    "author": [
      {
        "name": "BACOU, Melanie",
        "url": "https://linkedin/in/mbacou"
      }
    ],
    "date": "2021-10-18",
    "categories": [],
    "contents": "\n\nContents\nData Preparation\nTreemaps\nSteamgraphs\n\nThis notebook is to explore multiple visualization schemes:\nInteractive SVG: add user interactivity to existing SVG (or simplified) designs using low-level D3.js library\nGraphviz: redesign the WA+ sheets using Graphviz and provide interactivity with DiagrammeR\nHighcharts: reshape WA+ model output to create standard treemaps using Highcharts.js charting library\nHighcharts: reshape WA+ model output to create steam graphs and/or network graphs\nLeaflet: create a 3D map of basin landscape with SVG annotations (arrows, etc.) using leaflet.js\nData Preparation\nTo validate the different approaches we use sample model output and datasets provided by Naga Valpuri for Mali (Niger river basin) and Kenya (Mara basin).\n\n\nShow code\n\ndata <- list(\n  ken = \"../../_data/ken/hydroloop_results/csv\",\n  mli = \"../../_data/mli/csv_km3\"\n) %>%\n  lapply(list.files, pattern=\"*.csv\", recursive=TRUE, full.names=TRUE) %>%\n  lapply(data.table) %>%\n  rbindlist(idcol=\"iso3\", use.names=TRUE, fill=TRUE) %>%\n  setnames(\"V1\", \"path\")\n\ndata[, \n  file := basename(path)\n][, `:=`(\n  year = str_extract(file, \"_[0-9]{4}\") %>% str_sub(2,5) %>% as.integer(),\n  month = str_extract(file, \"[0-9]{4}_[0-9]{1,2}\") %>% str_sub(6,7) %>% as.integer()\n)] %>% setorder(iso3, year, month, na.last=TRUE)\n\ndata[iso3==\"ken\", .(file, year, month)][c(1:5, (.N-4):.N)] %>% \n  kable(caption=\"Kenya - List of output files (top and last 5)\")\n\n\nTable 1: Kenya - List of output files (top and last 5)\nfile\nyear\nmonth\nsheet1_2003_1.csv\n2003\n1\nsheet2_2003_1.csv\n2003\n1\nsheet1_2003_2.csv\n2003\n2\nsheet2_2003_2.csv\n2003\n2\nsheet1_2003_3.csv\n2003\n3\nsheet5_subbasin_1_supply_sw.csv\n–\n–\nsheet6_recharge.csv\n–\n–\nsheet6_return_gw_from_gw.csv\n–\n–\nsheet6_return_gw_from_sw.csv\n–\n–\nsheet6_supply_gw.csv\n–\n–\n\nShow code\n\ndata[iso3==\"mli\", .(file, year, month)] %>% \n  kable(caption=\"Mali - List of output files\")\n\n\nTable 1: Mali - List of output files\nfile\nyear\nmonth\nSheet1_2010.csv\n2010\n–\nSheet1_2011.csv\n2011\n–\nSheet1_2012.csv\n2012\n–\nSheet1_2013.csv\n2013\n–\nSheet1_2014.csv\n2014\n–\nSheet1_2015.csv\n2015\n–\nSheet1_2016.csv\n2016\n–\nSheet1_2017.csv\n2017\n–\n\nIn particular we have yearly (2 seasons) model steps for Mali and monthly steps for Kenya that are further aggregated to seasonal and yearly time spans (by variable), as well as monthly time-series. In Mali only Sheet 1 was produced (Resource Base).\nLet’s load a sample output for Kenya for the year 2017.\n\n\nShow code\n\nf <- \"sheet1_2017.csv\"\nken <- data[iso3==\"ken\" & file==f][1, fread(path)]\nken %>% \n  kable(caption=f)\n\n\nTable 2: sheet1_2017.csv\nCLASS\nSUBCLASS\nVARIABLE\nVALUE\nINFLOW\nPRECIPITATION\nRainfall\n13.1648139\nINFLOW\nPRECIPITATION\nSnowfall\n0.0000000\nINFLOW\nPRECIPITATION\nPrecipitation recycling\n0.0000000\nINFLOW\nSURFACE WATER\nMain riverstem\n0.0000000\nINFLOW\nSURFACE WATER\nTributaries\n0.0000000\nINFLOW\nSURFACE WATER\nUtilized surface water\n0.0000000\nINFLOW\nSURFACE WATER\nFlood\n0.0000000\nINFLOW\nGROUNDWATER\nNatural\n0.0000000\nINFLOW\nGROUNDWATER\nUtilized\n0.0000000\nINFLOW\nOTHER\nDesalinized\n0.0000000\nSTORAGE\nCHANGE\nSurface storage\n-3.8472840\nSTORAGE\nCHANGE\nStorage in sinks\n0.0000000\nOUTFLOW\nET LANDSCAPE\nProtected\n1.3877507\nOUTFLOW\nET LANDSCAPE\nUtilized\n2.4564371\nOUTFLOW\nET LANDSCAPE\nModified\n3.0237088\nOUTFLOW\nET LANDSCAPE\nManaged\n0.0985108\nOUTFLOW\nET UTILIZED FLOW\nProtected\n0.0124669\nOUTFLOW\nET UTILIZED FLOW\nUtilized\n0.6943683\nOUTFLOW\nET UTILIZED FLOW\nModified\n0.0771237\nOUTFLOW\nET UTILIZED FLOW\nManaged\n0.6134008\nOUTFLOW\nET INCREMENTAL\nManmade\n0.0023120\nOUTFLOW\nET INCREMENTAL\nNatural\n0.7839588\nOUTFLOW\nSURFACE WATER\nMain riverstem\n1.5648516\nOUTFLOW\nSURFACE WATER\nTributaries\n0.0000000\nOUTFLOW\nSURFACE WATER\nUtilized surface water\n0.0000000\nOUTFLOW\nSURFACE WATER\nFlood\n0.0000000\nOUTFLOW\nSURFACE WATER\nInterbasin transfer\n0.0000000\nOUTFLOW\nGROUNDWATER\nNatural\n0.0000000\nOUTFLOW\nGROUNDWATER\nUtilized\n0.0000000\nOUTFLOW\nOTHER\nNon-utilizable\n0.0000000\nOUTFLOW\nOTHER\nOther\n0.0000000\nOUTFLOW\nRESERVED\nCommited\n0.6405242\nOUTFLOW\nRESERVED\nNavigational\n0.0000000\nOUTFLOW\nRESERVED\nEnvironmental\n0.0000000\n\nThis file lists 34 output variables grouped into CLASS and SUBCLASS. Units are in km³/year.\nTreemaps\nFirst we define a default theme for Highcharts objects.\n\n\nShow code\n\nhc_theme_iwmi <- function(\n  hc,\n  title = NULL,\n  subtitle = NULL,\n  label = NULL,\n  x = NULL,\n  y = NULL,\n  exporting = TRUE,\n  credits = FALSE,\n  ...) {\n  \n  thm <- hc_theme(\n    \n    chart = list(\n      backgroundColor = \"transparent\"\n    ),\n    # Don't use semantic colors\n    colors = unname(pal),\n    title = list(\n      style = list(color=\"#333\", fontSize=\"16px\"),\n      align = \"left\"\n    ),\n    subtitle = list(\n      style = list(color='#777', fontSize=\"13px\"),\n      align = \"left\"\n    ),\n    legend = list(\n      enabled = TRUE,\n      itemStyle = list(color=\"#777\"),\n      verticalAlign = \"top\",\n      align = \"left\",\n      itemHoverStyle = list(color=\"#333\")\n    ),\n    xAxis = list(\n      title = list(enabled=FALSE),\n      dateTimeLabelFormats = list(day='%e %b', week='%e %b %y', month='%b-%y', year='%Y'))\n    ,\n    yAxis = list(\n      title = list(enabled=FALSE)\n    ),\n    tooltip = list(\n      enabled = TRUE, shared = TRUE, split = FALSE,\n      pointFormat = \"{series.name}: <strong>{point.y:,.1f}<\/strong><br/>\",\n      xDateFormat = \"%Y-%m-%d\",\n      dateTimeLabelFormats = \"%Y-%m-%d\",\n      valueDecimals = 2\n    ),\n    plotOptions = list(\n      series = list(\n        opacity = .8,\n        connectNulls = TRUE,\n        marker = list(enabled=NA, radius=3, enabledThreshold=8),\n        dataLabels = list(enabled=NA, style=list(fontSize=\"11px\"))\n      ),\n      heatmap = list(\n        marker = list(enabled=TRUE, lineWidth=6, lineColor=\"#fff\"),\n        dataLabels = list(enabled=TRUE, pointFormat=\"{point.value:,.0f}\")\n      )\n    ),\n    exporting = list(\n      enabled = exporting,\n      csv = list(dateFormat=\"%Y-%m-%d\"),\n      buttons = list(contextButton=list(\n        symbolSize = 12,\n        symbolFill = \"#fff\",\n        symbolStroke = \"#777\",\n        symbolStrokeWidth = 1.3,\n        menuItems = c(\"printChart\", \"downloadPNG\", \"downloadSVG\", \"downloadCSV\")))\n    ),\n    credits = list(\n      enabled = credits,\n      position = list(align=\"left\"),\n      href = \"https://iwni.cgiar.org/\",\n      style = list(fontSize=\"11px\")\n    ),\n    ...\n  )\n  \n  p  = hc_add_theme(hc, thm) %>%\n    hc_title(text = title) %>%\n    hc_subtitle(text = subtitle)\n  \n  if(length(label)>0) p = p %>%\n    hc_annotations(list(labels = list(\n      list(text=label, useHTML=TRUE, shape=\"rect\", point=list(x=x, y=y)))))\n  \n  return(p)\n}\n\n\n\nA barebone treemap to start with.\n\n\nShow code\n\n# Add shaded colors\nken[, COLOR := abs(VALUE)] %>%\n  data_to_hierarchical(c(CLASS, SUBCLASS, VARIABLE), COLOR, pal[c(2,4,3)]) %>%\n  hchart(\n    type = \"treemap\",\n    layoutAlgorithm = \"squarified\",\n    dataLabels = list(enabled=T, format=\"{point.name}\"),\n    tooltip = list(pointFormat=\"\n      {point.parent}<br/>{point.name}<br/>Value: {point.value:,.2f}\")\n  ) %>%\n  hc_theme_iwmi(\"Resource Base\", \"Kenya 2017\") %>%\n  hc_exporting(enabled=TRUE)\n\n\n\n\n{\"x\":{\"hc_opts\":{\"chart\":{\"reflow\":true},\"title\":{\"text\":\"Resource Base\"},\"yAxis\":{\"title\":{\"text\":null}},\"credits\":{\"enabled\":false},\"exporting\":{\"enabled\":true},\"boost\":{\"enabled\":false},\"plotOptions\":{\"series\":{\"label\":{\"enabled\":false},\"turboThreshold\":0},\"treemap\":{\"layoutAlgorithm\":\"squarified\"}},\"series\":[{\"data\":[{\"name\":\"INFLOW\",\"id\":\"inflow\",\"color\":\"#37517ECC\",\"level\":1},{\"name\":\"STORAGE\",\"id\":\"storage\",\"color\":\"#008EC0CC\",\"level\":1},{\"name\":\"OUTFLOW\",\"id\":\"outflow\",\"color\":\"#2ED06ECC\",\"level\":1},{\"name\":\"PRECIPITATION\",\"id\":\"inflow_precipitation\",\"parent\":\"inflow\",\"level\":2},{\"name\":\"CHANGE\",\"id\":\"storage_change\",\"parent\":\"storage\",\"level\":2},{\"name\":\"ET LANDSCAPE\",\"id\":\"outflow_et_landscape\",\"parent\":\"outflow\",\"level\":2},{\"name\":\"SURFACE WATER\",\"id\":\"outflow_surface_water\",\"parent\":\"outflow\",\"level\":2},{\"name\":\"ET INCREMENTAL\",\"id\":\"outflow_et_incremental\",\"parent\":\"outflow\",\"level\":2},{\"name\":\"ET UTILIZED FLOW\",\"id\":\"outflow_et_utilized_flow\",\"parent\":\"outflow\",\"level\":2},{\"name\":\"RESERVED\",\"id\":\"outflow_reserved\",\"parent\":\"outflow\",\"level\":2},{\"name\":\"GROUNDWATER\",\"id\":\"inflow_groundwater\",\"parent\":\"inflow\",\"level\":2},{\"name\":\"OTHER\",\"id\":\"inflow_other\",\"parent\":\"inflow\",\"level\":2},{\"name\":\"SURFACE WATER\",\"id\":\"inflow_surface_water\",\"parent\":\"inflow\",\"level\":2},{\"name\":\"GROUNDWATER\",\"id\":\"outflow_groundwater\",\"parent\":\"outflow\",\"level\":2},{\"name\":\"OTHER\",\"id\":\"outflow_other\",\"parent\":\"outflow\",\"level\":2},{\"name\":\"Rainfall\",\"id\":\"inflow_precipitation_rainfall\",\"parent\":\"inflow_precipitation\",\"value\":13.164813876489,\"level\":3},{\"name\":\"Surface storage\",\"id\":\"storage_change_surface_storage\",\"parent\":\"storage_change\",\"value\":3.84728400660859,\"level\":3},{\"name\":\"Modified\",\"id\":\"outflow_et_landscape_modified\",\"parent\":\"outflow_et_landscape\",\"value\":3.02370881523295,\"level\":3},{\"name\":\"Utilized\",\"id\":\"outflow_et_landscape_utilized\",\"parent\":\"outflow_et_landscape\",\"value\":2.45643709826886,\"level\":3},{\"name\":\"Main riverstem\",\"id\":\"outflow_surface_water_main_riverstem\",\"parent\":\"outflow_surface_water\",\"value\":1.56485159776,\"level\":3},{\"name\":\"Protected\",\"id\":\"outflow_et_landscape_protected\",\"parent\":\"outflow_et_landscape\",\"value\":1.38775071807163,\"level\":3},{\"name\":\"Natural\",\"id\":\"outflow_et_incremental_natural\",\"parent\":\"outflow_et_incremental\",\"value\":0.783958849116986,\"level\":3},{\"name\":\"Utilized\",\"id\":\"outflow_et_utilized_flow_utilized\",\"parent\":\"outflow_et_utilized_flow\",\"value\":0.694368257262539,\"level\":3},{\"name\":\"Commited\",\"id\":\"outflow_reserved_commited\",\"parent\":\"outflow_reserved\",\"value\":0.640524194184507,\"level\":3},{\"name\":\"Managed\",\"id\":\"outflow_et_utilized_flow_managed\",\"parent\":\"outflow_et_utilized_flow\",\"value\":0.613400765604048,\"level\":3},{\"name\":\"Managed\",\"id\":\"outflow_et_landscape_managed\",\"parent\":\"outflow_et_landscape\",\"value\":0.0985107663369928,\"level\":3},{\"name\":\"Modified\",\"id\":\"outflow_et_utilized_flow_modified\",\"parent\":\"outflow_et_utilized_flow\",\"value\":0.0771236544917457,\"level\":3},{\"name\":\"Protected\",\"id\":\"outflow_et_utilized_flow_protected\",\"parent\":\"outflow_et_utilized_flow\",\"value\":0.012466937362701,\"level\":3},{\"name\":\"Manmade\",\"id\":\"outflow_et_incremental_manmade\",\"parent\":\"outflow_et_incremental\",\"value\":0.00231202509297041,\"level\":3},{\"name\":\"Natural\",\"id\":\"inflow_groundwater_natural\",\"parent\":\"inflow_groundwater\",\"value\":0,\"level\":3},{\"name\":\"Utilized\",\"id\":\"inflow_groundwater_utilized\",\"parent\":\"inflow_groundwater\",\"value\":0,\"level\":3},{\"name\":\"Desalinized\",\"id\":\"inflow_other_desalinized\",\"parent\":\"inflow_other\",\"value\":0,\"level\":3},{\"name\":\"Precipitation recycling\",\"id\":\"inflow_precipitation_precipitation_recycling\",\"parent\":\"inflow_precipitation\",\"value\":0,\"level\":3},{\"name\":\"Snowfall\",\"id\":\"inflow_precipitation_snowfall\",\"parent\":\"inflow_precipitation\",\"value\":0,\"level\":3},{\"name\":\"Flood\",\"id\":\"inflow_surface_water_flood\",\"parent\":\"inflow_surface_water\",\"value\":0,\"level\":3},{\"name\":\"Main riverstem\",\"id\":\"inflow_surface_water_main_riverstem\",\"parent\":\"inflow_surface_water\",\"value\":0,\"level\":3},{\"name\":\"Tributaries\",\"id\":\"inflow_surface_water_tributaries\",\"parent\":\"inflow_surface_water\",\"value\":0,\"level\":3},{\"name\":\"Utilized surface water\",\"id\":\"inflow_surface_water_utilized_surface_water\",\"parent\":\"inflow_surface_water\",\"value\":0,\"level\":3},{\"name\":\"Natural\",\"id\":\"outflow_groundwater_natural\",\"parent\":\"outflow_groundwater\",\"value\":0,\"level\":3},{\"name\":\"Utilized\",\"id\":\"outflow_groundwater_utilized\",\"parent\":\"outflow_groundwater\",\"value\":0,\"level\":3},{\"name\":\"Non-utilizable\",\"id\":\"outflow_other_non-utilizable\",\"parent\":\"outflow_other\",\"value\":0,\"level\":3},{\"name\":\"Other\",\"id\":\"outflow_other_other\",\"parent\":\"outflow_other\",\"value\":0,\"level\":3},{\"name\":\"Environmental\",\"id\":\"outflow_reserved_environmental\",\"parent\":\"outflow_reserved\",\"value\":0,\"level\":3},{\"name\":\"Navigational\",\"id\":\"outflow_reserved_navigational\",\"parent\":\"outflow_reserved\",\"value\":0,\"level\":3},{\"name\":\"Flood\",\"id\":\"outflow_surface_water_flood\",\"parent\":\"outflow_surface_water\",\"value\":0,\"level\":3},{\"name\":\"Interbasin transfer\",\"id\":\"outflow_surface_water_interbasin_transfer\",\"parent\":\"outflow_surface_water\",\"value\":0,\"level\":3},{\"name\":\"Tributaries\",\"id\":\"outflow_surface_water_tributaries\",\"parent\":\"outflow_surface_water\",\"value\":0,\"level\":3},{\"name\":\"Utilized surface water\",\"id\":\"outflow_surface_water_utilized_surface_water\",\"parent\":\"outflow_surface_water\",\"value\":0,\"level\":3},{\"name\":\"Storage in sinks\",\"id\":\"storage_change_storage_in_sinks\",\"parent\":\"storage_change\",\"value\":0,\"level\":3}],\"type\":\"treemap\",\"layoutAlgorithm\":\"squarified\",\"dataLabels\":{\"enabled\":true,\"format\":\"{point.name}\"},\"tooltip\":{\"pointFormat\":\"\\n      {point.parent}<br/>{point.name}<br/>Value: {point.value:,.2f}\"}}],\"subtitle\":{\"text\":\"Kenya 2017\"}},\"theme\":{\"chart\":{\"backgroundColor\":\"transparent\"},\"colors\":[\"#253655CC\",\"#37517ECC\",\"#2ED06ECC\",\"#008EC0CC\",\"#FFA600CC\",\"#C22E2ECC\"],\"title\":{\"style\":{\"color\":\"#333\",\"fontSize\":\"16px\"},\"align\":\"left\"},\"subtitle\":{\"style\":{\"color\":\"#777\",\"fontSize\":\"13px\"},\"align\":\"left\"},\"legend\":{\"enabled\":true,\"itemStyle\":{\"color\":\"#777\"},\"verticalAlign\":\"top\",\"align\":\"left\",\"itemHoverStyle\":{\"color\":\"#333\"}},\"xAxis\":{\"title\":{\"enabled\":false},\"dateTimeLabelFormats\":{\"day\":\"%e %b\",\"week\":\"%e %b %y\",\"month\":\"%b-%y\",\"year\":\"%Y\"}},\"yAxis\":{\"title\":{\"enabled\":false}},\"tooltip\":{\"enabled\":true,\"shared\":true,\"split\":false,\"pointFormat\":\"{series.name}: <strong>{point.y:,.1f}<\\/strong><br/>\",\"xDateFormat\":\"%Y-%m-%d\",\"dateTimeLabelFormats\":\"%Y-%m-%d\",\"valueDecimals\":2},\"plotOptions\":{\"series\":{\"opacity\":0.8,\"connectNulls\":true,\"marker\":{\"enabled\":null,\"radius\":3,\"enabledThreshold\":8},\"dataLabels\":{\"enabled\":null,\"style\":{\"fontSize\":\"11px\"}}},\"heatmap\":{\"marker\":{\"enabled\":true,\"lineWidth\":6,\"lineColor\":\"#fff\"},\"dataLabels\":{\"enabled\":true,\"pointFormat\":\"{point.value:,.0f}\"}}},\"exporting\":{\"enabled\":true,\"csv\":{\"dateFormat\":\"%Y-%m-%d\"},\"buttons\":{\"contextButton\":{\"symbolSize\":12,\"symbolFill\":\"#fff\",\"symbolStroke\":\"#777\",\"symbolStrokeWidth\":1.3,\"menuItems\":[\"printChart\",\"downloadPNG\",\"downloadSVG\",\"downloadCSV\"]}}},\"credits\":{\"enabled\":false,\"position\":{\"align\":\"left\"},\"href\":\"https://iwni.cgiar.org/\",\"style\":{\"fontSize\":\"11px\"}}},\"conf_opts\":{\"global\":{\"Date\":null,\"VMLRadialGradientURL\":\"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png\",\"canvasToolsURL\":\"http =//code.highcharts.com/list(version)/modules/canvas-tools.js\",\"getTimezoneOffset\":null,\"timezoneOffset\":0,\"useUTC\":true},\"lang\":{\"contextButtonTitle\":\"Chart context menu\",\"decimalPoint\":\".\",\"downloadCSV\":\"Download CSV\",\"downloadJPEG\":\"Download JPEG image\",\"downloadPDF\":\"Download PDF document\",\"downloadPNG\":\"Download PNG image\",\"downloadSVG\":\"Download SVG vector image\",\"downloadXLS\":\"Download XLS\",\"drillUpText\":\"◁ Back to {series.name}\",\"exitFullscreen\":\"Exit from full screen\",\"exportData\":{\"annotationHeader\":\"Annotations\",\"categoryDatetimeHeader\":\"DateTime\",\"categoryHeader\":\"Category\"},\"hideData\":\"Hide data table\",\"invalidDate\":null,\"loading\":\"Loading...\",\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"noData\":\"No data to display\",\"numericSymbolMagnitude\":1000,\"numericSymbols\":[\"k\",\"M\",\"G\",\"T\",\"P\",\"E\"],\"printChart\":\"Print chart\",\"resetZoom\":\"Reset zoom\",\"resetZoomTitle\":\"Reset zoom level 1:1\",\"shortMonths\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"shortWeekdays\":[\"Sat\",\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"],\"thousandsSep\":\" \",\"viewData\":\"View data table\",\"viewFullscreen\":\"View in full screen\",\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]}},\"type\":\"chart\",\"fonts\":[],\"debug\":false},\"evals\":[],\"jsHooks\":[]}\nFigure 1: Sample Treemap\n\n\n\nSteamgraphs\n\n\n\n",
    "preview": "posts/2021-18-highcharts/resource-base.svg",
    "last_modified": "2021-10-18T07:17:36+01:00",
    "input_file": {}
  }
]
