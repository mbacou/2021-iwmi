---
title: Custom Highcharts
description: |
  Part 2: build custom data-driven charts using Highcharts.js (IWMI).
author:
  - name: BACOU, Melanie
    email: mel@mbacou.com
    url: https://linkedin/in/mbacou
preview: resource-base.svg
date: "`r Sys.Date()`"
date_prefix: 2020-10-01
output:
  distill::distill_article:
    dev: svglite
    code_folding: true
    self_contained: false
---

```{r setup, include=FALSE}

library(knitr)
library(jsonlite)
library(scales)
library(stringr)
library(data.table)
library(highcharter)

opts_chunk$set(res=220, pointsize=8)

# Default color palette
pal <- readRDS("../../_assets/palette.rds")

```


This notebook is to explore multiple visualization schemes:

1. **Interactive SVG**: add user interactivity to existing SVG (or simplified) designs using low-level [D3.js](https://d3js.org/) library
2. **Graphviz**: redesign the WA+ sheets using [Graphviz](https://graphviz.org/) and provide interactivity with [DiagrammeR](https://rich-iannone.github.io/DiagrammeR/)
2. **Highcharts**: reshape WA+ model output to create standard treemaps using [Highcharts.js](https://www.highcharts.com/) charting library
3. **Highcharts**: reshape WA+ model output to create steam graphs and/or network graphs
4. **Leaflet**: create a 3D map of basin landscape with SVG annotations (arrows, etc.) using [leaflet.js](https://leafletjs.com/)


# Data Preparation

To validate the different approaches we use sample model output and datasets provided by **Naga Valpuri** for Mali (Niger river basin) and Kenya (Mara basin). 

```{r}

data <- list(
  ken = "~/Projects/2021-iwmi/data/ken/hydroloop_results/csv",
  mli = "~/Projects/2021-iwmi/data/mli/csv_km3"
) %>%
  lapply(list.files, pattern="*.csv", recursive=TRUE, full.names=TRUE) %>%
  lapply(data.table) %>%
  rbindlist(idcol="iso3", use.names=TRUE, fill=TRUE) %>%
  setnames("V1", "path")

data[, 
  file := basename(path)
][, `:=`(
  year = str_extract(file, "_[0-9]{4}") %>% str_sub(2,5) %>% as.integer(),
  month = str_extract(file, "[0-9]{4}_[0-9]{1,2}") %>% str_sub(6,7) %>% as.integer()
)] %>% setorder(iso3, year, month, na.last=TRUE)

data[iso3=="ken", .(file, year, month)][c(1:5, (.N-4):.N)] %>% 
  kable(caption="Kenya - List of output files (top and last 5)")
data[iso3=="mli", .(file, year, month)] %>% 
  kable(caption="Mali - List of output files")

```

In particular we have yearly (2 seasons) model steps for Mali and monthly steps for Kenya that are further aggregated to seasonal and yearly time spans (by variable), as well as monthly time-series. In Mali only **Sheet 1** was produced (Resource Base).

Let's load a sample output for Kenya for the year 2017.

```{r}

f <- "sheet1_2017.csv"
ken <- data[iso3=="ken" & file==f][1, fread(path)]
ken %>% 
  kable(caption=f)

```

This file lists `r nrow(ken)` output variables grouped into `CLASS` and `SUBCLASS`. Units are in **kmÂ³/year**.


# Treemaps

First we define a default theme for Highcharts objects.

```{r}

hc_theme_iwmi <- function(
  hc,
  title = NULL,
  subtitle = NULL,
  label = NULL,
  x = NULL,
  y = NULL,
  exporting = TRUE,
  credits = FALSE,
  ...) {
  
  thm <- hc_theme(
    
    chart = list(
      backgroundColor = "transparent"
    ),
    # Don't use semantic colors
    colors = unname(pal),
    title = list(
      style = list(color="#333", fontSize="16px"),
      align = "left"
    ),
    subtitle = list(
      style = list(color='#777', fontSize="13px"),
      align = "left"
    ),
    legend = list(
      enabled = TRUE,
      itemStyle = list(color="#777"),
      verticalAlign = "top",
      align = "left",
      itemHoverStyle = list(color="#333")
    ),
    xAxis = list(
      title = list(enabled=FALSE),
      dateTimeLabelFormats = list(day='%e %b', week='%e %b %y', month='%b-%y', year='%Y'))
    ,
    yAxis = list(
      title = list(enabled=FALSE)
    ),
    tooltip = list(
      enabled = TRUE, shared = TRUE, split = FALSE,
      pointFormat = "{series.name}: <strong>{point.y:,.1f}</strong><br/>",
      xDateFormat = "%Y-%m-%d",
      dateTimeLabelFormats = "%Y-%m-%d",
      valueDecimals = 2
    ),
    plotOptions = list(
      series = list(
        opacity = .8,
        connectNulls = TRUE,
        marker = list(enabled=NA, radius=3, enabledThreshold=8),
        dataLabels = list(enabled=NA, style=list(fontSize="11px"))
      ),
      heatmap = list(
        marker = list(enabled=TRUE, lineWidth=6, lineColor="#fff"),
        dataLabels = list(enabled=TRUE, pointFormat="{point.value:,.0f}")
      )
    ),
    exporting = list(
      enabled = exporting,
      csv = list(dateFormat="%Y-%m-%d"),
      buttons = list(contextButton=list(
        symbolSize = 12,
        symbolFill = "#fff",
        symbolStroke = "#777",
        symbolStrokeWidth = 1.3,
        menuItems = c("printChart", "downloadPNG", "downloadSVG", "downloadCSV")))
    ),
    credits = list(
      enabled = credits,
      position = list(align="left"),
      href = "https://iwni.cgiar.org/",
      style = list(fontSize="11px")
    ),
    ...
  )
  
  p  = hc_add_theme(hc, thm) %>%
    hc_title(text = title) %>%
    hc_subtitle(text = subtitle)
  
  if(length(label)>0) p = p %>%
    hc_annotations(list(labels = list(
      list(text=label, useHTML=TRUE, shape="rect", point=list(x=x, y=y)))))
  
  return(p)
}

```

A barebone treemap to start with.


```{r, fig.cap="Sample Treemap", preview=TRUE}

# Add shaded colors
ken[, COLOR := abs(VALUE)] %>%
  data_to_hierarchical(c(CLASS, SUBCLASS, VARIABLE), COLOR, pal[c(2,4,3)]) %>%
  hchart(
    type = "treemap",
    layoutAlgorithm = "squarified",
    dataLabels = list(enabled=T, format="{point.name}"),
    tooltip = list(pointFormat="
      {point.parent}<br/>{point.name}<br/>Value: {point.value:,.2f}")
  ) %>%
  hc_theme_iwmi("Resource Base", "Kenya 2017") %>%
  hc_exporting(enabled=TRUE)

```


# Steamgraphs


