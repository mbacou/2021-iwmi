---
title: "Visualizing Water: Interactive Timelapse Map of River Basins (draft)"
description: |
  Part 3: how to represent water flux over 3D maps of river basins.
author:
  - name: BACOU, Melanie
    email: mel@mbacou.com
    url: https://linkedin/in/mbacou
preview: ../../www/fig/webgl.png
categories:
  - draft
  - imwi
  - hydrology
date: "`r Sys.Date()`"
date_prefix: 2021-10-24
output:
  distill::distill_article:
    toc: true
    dev: svglite
    code_folding: true
    self_contained: false
---

```{r setup, include=FALSE}

if(interactive()) setwd("_posts/2021-10-24-3dmap/")

library(knitr)
library(scales)
library(stringr)
library(data.table)
library(raster)
library(rayshader)
library(rayrender)
library(rgl)
setupKnitr(autoprint=TRUE)

opts_chunk$set(res=220, pointsize=8)

# Default color palette
pal <- readRDS("../../_assets/pal_iwmi.rds")
par(font.main=1, cex.axis=.8)

```


This notebook is **Part 3** of an exploration to visualize results of hydrologic models. In [Part 1](../2021-10-16-svg/) we built custom HTML widgets using `D3.js`, and in [Part 2](../2021-10-12-highcharts/) we looked at rendering water fluxes using Sankey diagrams. Here we test multiple libraries to generate hillshade (3D) views of river basins and water infrastructure, in particular we want to compare [leaflet](https://leafletjs.com/), [Three.js](https://threejs.org/) and [MapboxGL](https://docs.mapbox.com/mapbox-gl-js/example/) implementations.

Aside from rendering spatial terrain and water streams in 3D (and potentially other covariate layers), our objective is to overlay custom labels to illustrate and quantify the hydrological cycle.

Some inspiration below:

- [NASA Web WorldWind](https://worldwind.arc.nasa.gov/web/examples/#anchor)
- [Flood depth on 3D terrain](https://observablehq.com/@sw1227/flood-depth-map-on-3d-terrain?collection=@sw1227/geo)
- Contouring with [Threes.js](https://observablehq.com/@sw1227/contoured-mountainious-terrai-3d?collection=@sw1227/3d)


```{r}


```



# Data Acquisition

We'll start with a sample scene of the **Selingue Dam** in the Niger River basin.


```{r, layout="l-body", code_folding=F}

basin <- shapefile("~/Projects/2021-iwmi/data/mli/srtm/mli_basin.shp")
zoi <- shapefile("~/Projects/2021-iwmi/data/mli/srtm/zoi.shp")
ext <- extent(zoi)
center <- coordinates(zoi)

# Get CGIAR SRTM DEM at 90m
getData("SRTM", lon=center[,1], lat=center[,2], path="_data") %>%
  crop(zoi) %>%
  mask(zoi) -> srtm
srtm

# Get LUC
#luc <- raster("~/Projects/2021-iwmi/data/mli/stat/")

# Admin boundaries

```

The basin covers a large area, so we need 8 SRTM tiles, but 1 is enough for a proof of concept. Next we'll get a satellite basemap.

```{r, out.width="33%", fig.show="hold", code_folding=F}

# Satellite basemaps
maptiles::get_tiles(terra::ext(zoi), "Esri.WorldImagery", zoom=12) %>%
  stack() %>%
  crop(zoi) %>%
  mask(zoi) %>%
  resample(srtm) -> bmap

plot(terra::vect(basin), axes=T, asp=1, col=pal[2], border=pal[1], lwd=2,
  main="Niger River Basin (Mali)")
plot(zoi, add=T, lty=3, col=alpha(pal["red"], .6), border=pal["red"], lwd=2)
text(-8, 10.5, "Selingue Dam\n(Mali)", col=pal["red"], cex=.7, font=2)
grid()

plot(terra::ext(zoi), axes=T, asp=1, border=NA, 
  main="Selingue Dam (Mali) - ESRI World Imagery")
plotRGB(bmap, add=T)
grid(col="white")

plot(srtm, axes=T, asp=1, border=NA, 
  main="Selingue Dam (Mali) - SRTM 90m")
grid(col="white")

```

Next we convert the 2 rasters to a matrix format that's compatible with [Rayshader](https://github.com/tylermorganwall/rayshader/) methods.

```{r}

# Convert rasters to rayshader matrix format
srtm_array <- raster_to_matrix(srtm)
r <- raster_to_matrix(bmap$red)
g <- raster_to_matrix(bmap$green)
b <- raster_to_matrix(bmap$blue)

bmap_array <- array(0, dim=c(nrow(r), ncol(r), 3))
bmap_array[,,1] <- r/255
bmap_array[,,2] <- g/255
bmap_array[,,3] <- b/255

bmap_array %>%
  aperm(c(2,1,3)) %>%
  # Stretch contrast
  rescale(to=c(0,1)) -> bmap_array

```

Rendering the (downsampled) 90m SRTM elevation map with WebGL and a satellite texture.

```{r, code_folding=F, fig.cap="Interactive 3D Scene of Selingue Dam (Niger River basin)"}

getData("alt", country="MLI", path="_data") %>%
  crop(zoi) %>%
  raster_to_matrix() -> alt

srtm_array %>%
  sphere_shade(texture="bw") %>%
  add_overlay(bmap_array, alphalayer=.8)  %>%
  add_overlay(height_shade(srtm_array), alphalayer=0.6)  %>%
  #add_shadow(ray_shade(srtm_array, zscale=90)) %>%
  plot_3d(alt,
    windowsize=c(600, 600), zscale=20, zoom=0.5,
    phi=30, theta=20, fov=70,
    shadow=TRUE, shadowcolor=pal["black"],
    water=FALSE, waterdepth=360, watercolor=pal["blue"], waterlinecolor=pal["blue"]) 

rglwidget()

```

Using the same steps as above we could test with multiple basemaps, e.g. OpenTopoMap and ThunderForest, that might help highlight more of the topological features.

```{r}

# Satellite basemaps
maptiles::get_tiles(terra::ext(zoi), "Thunderforest.Outdoors", zoom=12,
  apikey="0d9308069306459f86443180dadc39ac") %>%
  stack() %>%
  crop(zoi) %>%
  mask(zoi) %>%
  resample(srtm) -> bmap

# Convert rasters to rayshader matrix format
r <- raster_to_matrix(bmap$red)
g <- raster_to_matrix(bmap$green)
b <- raster_to_matrix(bmap$blue)

bmap_array <- array(0, dim=c(nrow(r), ncol(r), 3))
bmap_array[,,1] <- r/255
bmap_array[,,2] <- g/255
bmap_array[,,3] <- b/255

bmap_array %>%
  aperm(c(2,1,3)) %>%
  # Stretch contrast
  rescale(to=c(0,1)) -> bmap_array

```

```{r, code_folding=F, fig.cap="Interactive 3D Scene of Selingue Dam (Niger River basin)"}

srtm_array %>%
  height_shade() %>%
  add_overlay(bmap_array, alphalayer=1)  %>%
  add_overlay(height_shade(srtm_array), alphalayer=0.6)  %>%
  add_shadow(ray_shade(srtm_array, zscale=90)) %>%
  plot_3d(alt,
    windowsize=c(600, 600), zscale=20, zoom=0.5,
    phi=30, theta=20, fov=70,
    shadow=TRUE, shadowcolor=pal["black"],
    water=TRUE, waterdepth=336, watercolor=pal["blue"], waterlinecolor=pal["blue"]) 

rglwidget()

```

